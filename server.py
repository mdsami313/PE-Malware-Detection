from flask import Flask, render_template, request, flash, redirect, url_for
import os
from modules import static
import warnings
import yaml

app = Flask(__name__)
app.secret_key = "itissecret"
app.config['UPLOAD_FOLDER'] = "C:\\Users\\samis\\OneDrive\\Desktop\\MDML-MASTER\\static\\uploaded files"


extension_types = ["exe", "dll"]
file_ext = ("docx", "csv", "pdf", "xlsx", "txt","png", "jpg", "jpeg")

warnings.filterwarnings('ignore')

# Home Page
@app.route("/")
def home():
    return render_template("prediction.html", file_name=" ")

# Prediction Page 
@app.route("/uploader", methods=["GET", "POST"])
def uploader():
    if request.method == "POST":
        path = str(request.files.get('file'))
        print(path.split())
        print(path.split()[1].endswith(file_ext))
        if path.split()[1] == "''":
            flash("Input Field Cannot be Empty!") 
            return redirect(url_for("uploader") + "#about")
        elif path.split()[1].replace("'", "").endswith(file_ext):
            flash("Please Input A .EXE Or .DLL File")
            return redirect(url_for("uploader") + "#about")
        else:
            f = request.files['file']
            file_name = f.filename
            print(file_name)
            f.save(os.path.join(app.config['UPLOAD_FOLDER'], file_name))
            # print(file_name.split("."))
            print(f"static/uploaded files/{file_name}")

            file_path = f"static/uploaded files/{file_name}"

            if file_name is not None:
                result = None
                print("File is not None")
                print(file_path)
                if not result:
                    result = static.process(file_path)
                    print(result)
                    status, confidence, detected_capabilities, predicted_val = result 
            return render_template("prediction.html", file_name=file_name, status=status, confidence=confidence, capabilities=detected_capabilities, pred_result=predicted_val)
            
    else:
        return render_template("prediction.html", file_name=" ")


if __name__=="__main__":
    app.run(debug=True)
